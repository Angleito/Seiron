#!/usr/bin/env node

/**
 * WalletConnect Setup Script
 * 
 * This script helps users configure WalletConnect for the Seiron project
 * by prompting for the Project ID and updating the .env file
 */

const fs = require('fs')
const path = require('path')
const readline = require('readline')

const rl = readline.createInterface({
  input: process.stdin,
  output: process.stdout
})

const envFilePath = path.join(__dirname, '..', '.env')

function updateEnvFile(projectId) {
  try {
    let envContent = ''
    
    // Read existing .env file or create new one
    if (fs.existsSync(envFilePath)) {
      envContent = fs.readFileSync(envFilePath, 'utf8')
    } else {
      // Create basic .env structure
      envContent = `# Seiron Environment Variables
# Generated by setup-walletconnect.js

# Privy Configuration
VITE_PRIVY_APP_ID=your_privy_app_id_here
VITE_PRIVY_CLIENT_ID=

# WalletConnect Project ID (optional, for better wallet support)
# Get your project ID from https://cloud.walletconnect.com/
VITE_WALLETCONNECT_PROJECT_ID=

# Sei Network RPC (optional, defaults to public RPC)
VITE_SEI_RPC_URL=https://evm-rpc.sei-apis.com

# API Configuration
VITE_API_URL=
VITE_WS_URL=

# Orchestrator API Configuration
VITE_ORCHESTRATOR_API=
VITE_ORCHESTRATOR_WS=

# ElevenLabs Configuration (for voice features)
VITE_ELEVENLABS_VOICE_ID=your_elevenlabs_voice_id_here
VITE_VOICE_ENABLED=true

# Voice Settings (optional)
VITE_VOICE_STABILITY=0.75
VITE_VOICE_SIMILARITY_BOOST=0.75
VITE_VOICE_STYLE=0.5
VITE_VOICE_USE_SPEAKER_BOOST=true
`
    }
    
    // Update the WalletConnect Project ID
    if (envContent.includes('VITE_WALLETCONNECT_PROJECT_ID=')) {
      envContent = envContent.replace(
        /VITE_WALLETCONNECT_PROJECT_ID=.*/,
        `VITE_WALLETCONNECT_PROJECT_ID=${projectId}`
      )
    } else {
      envContent += `\n# WalletConnect Project ID\nVITE_WALLETCONNECT_PROJECT_ID=${projectId}\n`
    }
    
    // Write updated content
    fs.writeFileSync(envFilePath, envContent)
    
    console.log('âœ… Successfully updated .env file with WalletConnect Project ID')
    console.log('ğŸ”„ Please restart your development server for changes to take effect')
    
  } catch (error) {
    console.error('âŒ Error updating .env file:', error.message)
    process.exit(1)
  }
}

function validateProjectId(projectId) {
  if (!projectId || projectId.trim().length === 0) {
    return false
  }
  
  // Basic validation - should be alphanumeric string
  if (!/^[a-zA-Z0-9]+$/.test(projectId.trim())) {
    return false
  }
  
  return true
}

console.log('ğŸ‰ Seiron WalletConnect Setup')
console.log('===============================')
console.log('')
console.log('This script will help you configure WalletConnect for your Seiron project.')
console.log('')
console.log('To get started:')
console.log('1. Go to https://cloud.walletconnect.com/')
console.log('2. Sign up or log in')
console.log('3. Create a new project')
console.log('4. Copy your Project ID')
console.log('')

rl.question('ğŸ“ Enter your WalletConnect Project ID: ', (projectId) => {
  if (!validateProjectId(projectId)) {
    console.error('âŒ Invalid Project ID. Please make sure you copied it correctly.')
    console.error('   Project ID should be an alphanumeric string')
    rl.close()
    process.exit(1)
  }
  
  console.log('')
  console.log('ğŸ” Validating Project ID...')
  
  // Show what we're about to do
  console.log(`ğŸ“„ Project ID: ${projectId}`)
  console.log(`ğŸ“ .env file: ${envFilePath}`)
  console.log('')
  
  rl.question('âœ… Continue with this configuration? (y/N): ', (answer) => {
    if (answer.toLowerCase() === 'y' || answer.toLowerCase() === 'yes') {
      updateEnvFile(projectId)
      console.log('')
      console.log('ğŸ‰ WalletConnect configuration complete!')
      console.log('')
      console.log('Next steps:')
      console.log('1. Restart your development server: npm run dev')
      console.log('2. Check the browser console for WalletConnect status')
      console.log('3. Test wallet connections in your app')
      console.log('')
      console.log('Need help? Check the documentation:')
      console.log('- WalletConnect: https://docs.walletconnect.com/')
      console.log('- Seiron: Check the README.md file')
    } else {
      console.log('âŒ Setup cancelled')
    }
    
    rl.close()
  })
})

// Handle Ctrl+C
rl.on('SIGINT', () => {
  console.log('\nâŒ Setup cancelled by user')
  process.exit(0)
})